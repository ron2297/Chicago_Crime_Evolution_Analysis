---
title: "Current_Statistics_Chicago_Crime"
author: "Ronald Washington III"
date: "April 2, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(dplyr) 
library(readr)
library(ggplot2) 
library(knitr)
library(plyr)
library(maptools)
library(rgdal)
library(rgeos)
library(shapefiles)
library(sf)
library(sp)
library(spatstat)
```

# Reading in Data
```{r include=FALSE}
# Load Chicago Crimes 2016-2018 CSV
df_crime<-read.csv("C:/Users/Ron III/Desktop/processs_crime_data.csv",nrows = 50000)
#crime.data <- read.csv("https://data.cityofchicago.org/api/views/ijzp-q8t2/rows.csv?accessType=DOWNLOAD",nrows = 50000)
```

## Filtering Data to only top 5 types of crimes 


```{r}               
df_crime_top5 <- subset(df_crime, crime %in% c("THEFT", "BATTERY", "DAMAGE" ,"DRUG","ASSAULT"))
```


# Cluster Identification Methods

[INSERT EXPLAINATION: WHY ARE YOU PERFORMING POINT PATTERN ANALYSIS - Due to your data being spatial you are interested in understanding the underlying patterns that occur from crimes in Chicago, and want to identifying the variablity between them and observe their temporal changes throughout time and attempt to predict off of it]

[INSERT EXPLAINATION OF WHAT POINT PATTERN ANALYSIS IS]

[INSERT EXPLAINATION OF HOW YOUR DATA IS INHOMOGENEOUS DUE TO THE INTENSITY (DENISTY) OF YOUR DATA CHANGING DEPENDING ON THE SPACE (LOCATION). STATE THAT YOU WILL BE USING INHOMOGENEOUS POISSON PROCESS]

[INSERT DESCRIPTION: YOU ARE INTERESTED IN ANALYZING THE TOP 5 TYPES OF CRIME IN CHICAGO ARE DISTRIBUTED IN SPACE AND TIME. SPECIFICALLY YOU WANT TO INVESTIGATE THE INTERACTION BETWEEN THESE TYPES OF CRIMES WITHIN POLICE DISTRICTS OR BETWEEN EACH OTHER]


Within this section we will be implementing numerous techniques to check for any form of clustering within our data points. Here we will be utilizing point pattern analysis as a metric of finding clustering, and we will be utilizing the Kolmogorov-Smirnov test as another method of determining if there are clusters.

## Point Pattern Analysis

### Removing Outlier Coordinates
```{r}
df_crime_top5=df_crime_top5 %>% filter(Latitude > 40) 
df_crime_top5=df_crime_top5 %>% filter(Longitude > -90) 
```

```{r include=FALSE}
coords <- SpatialPoints(df_crime_top5[,c("Longitude","Latitude")])
crime_spatial_df <-SpatialPointsDataFrame(coords,df_crime_top5)
proj4string(crime_spatial_df) <- CRS("+proj=longlat +ellps=WGS84")
```


```{r}
plot(crime_spatial_df)
```



```{r include=FALSE}

# Setting up Window Size / Formatting points to fit into shape of Chicago

unzip("C:/Users/Ron III/Documents/GitHub/Chicago_Crime_Evolution_Analysis/Data_Sets_Files/Boundaries - ZIP Codes.zip", exdir = "C:/Users/Ron III/Documents/Crime_Research/shapefiles_1", overwrite = TRUE)

chicago_shp <- readOGR(dsn = "C:/Users/Ron III/Documents/GitHub/Chicago_Crime_Evolution_Analysis/shapefiles_1",layer = "geo_export_6c977322-0a01-4386-849c-278ec22209fe" )

w3=as.owin(chicago_shp)
```

```{r}
#crimeProj = spTransform(chicago_shp,CRS("+proj=longlat +ellps=WGS84"))

#crimePPP1 = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="THEFT"],crime_spatial_df$Latitude[crime_spatial_df$crime=="THEFT"],w3)
```

### Checking for Inhomogeneity

[INSERT EXPLAINATION OF WHAT INHOMOGENEITY IS AND HOW IT IS REGARDING THE VARYING DENISTIES WITHIN THE QUADRAT PLOTS, IF IT WERE HOMOGENEOUS THEN ALL THE QUADRANTS WOULD BE THE SAME NUMBER]


```{r fig.height=8, fig.width=12}

combining_plots <- function(crime_type){
  crimePPP1 = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime==crime_type],crime_spatial_df$Latitude[crime_spatial_df$crime==crime_type],w3)
  par(mfrow=c(1,2))
  plot(crimePPP1, main = paste0("Point Plotting",crime_type), pch = ".", cols =2)
  qc <- quadratcount(crimePPP1) 
  plot(qc, main = paste0("Quadratcounting ",crime_type))
}
```

```{r fig.height=8, fig.width=12}
combining_plots("ASSAULT")
combining_plots("BATTERY")
combining_plots("DAMAGE")
combining_plots("DRUG")
combining_plots("THEFT")
```

[CONFIRM THAT ALL OF THE QUADRAT COUNTING IS INHOMOGENEOUS AND THAT WE CAN NOW MOVE FORWARD WITH ESTIMATING INTENSITY]

### Calculating Distance (Nearest Neighborhood) of Crimes Patterns
```{r}
# nns<-nndist(ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="DRUG"],crime_spatial_df$Latitude[crime_spatial_df$crime=="DRUG"],w3))
# summary(nns)
# plot(Gest(crimePPP1), add = TRUE, lwd = 3)
```

```{r}
crimePPP_Theft = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="THEFT"],crime_spatial_df$Latitude[crime_spatial_df$crime=="THEFT"],w3)
crimePPP_Battery = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="BATTERY"],crime_spatial_df$Latitude[crime_spatial_df$crime=="BATTERY"],w3)
crimePPP_Damage = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="DAMAGE"],crime_spatial_df$Latitude[crime_spatial_df$crime=="DAMAGE"],w3)
crimePPP_Assault = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="ASSAULT"],crime_spatial_df$Latitude[crime_spatial_df$crime=="ASSAULT"],w3)
crimePPP_Drug = ppp(crime_spatial_df$Longitude[crime_spatial_df$crime=="DRUG"],crime_spatial_df$Latitude[crime_spatial_df$crime=="DRUG"],w3)

```


```{r}
marks(crimePPP_Assault) = rep("Assualt", npoints(crimePPP_Assault))
marks(crimePPP_Theft) = rep("Theft", npoints(crimePPP_Theft))
marks(crimePPP_Battery) = rep("Battery", npoints(crimePPP_Battery))
marks(crimePPP_Damage) = rep("Damage", npoints(crimePPP_Damage))
marks(crimePPP_Drug) = rep("Drug", npoints(crimePPP_Drug))


```

```{r}

# DONT TOUCH
Y = list(crimePPP_Assault,crimePPP_Battery,crimePPP_Damage,crimePPP_Drug,crimePPP_Theft)
X = crimePPP_Assault
for (i in 2: length(Y)){ X = superimpose(X,Y[[i]])}
#sapply(seq_along(Y),function(x){ X = superimpose(X,Y[[x]])})

marks(X)=as.factor(marks(X))
```

```{r}
# the lambda argument specifys the density plot for assessing inhomogeneity
(Minhom<-quadrat.test(crimePPP_Assault, nx = 4, ny = 10, method = "MonteCarlo", lambda = density(crimePPP_Assault, sigma = .5)))
```
```{r}
plot(density(crimePPP_Assault,sigma = .5), main = "grid counts for inhomogenious denisty")
plot(Minhom, cex = 0.5, col = "white", add = T)
```






### WORK ON - Calculating distances between Crime PPPs

```{r}
z<- crossdist(crimePPP_Assault,crimePPP_Theft)
plot(z)
mean(z)

b <- crossdist(crimePPP_Assault,crimePPP_Drug)
plot(b)
mean(b)

t.test(z,b)
```

```{r  fig.height=8, fig.width=12}
par(mfrow = c(1,2))
hist(nndist(crimePPP_Assault),breaks = 35, xlab = "distinace in meters", main = "Assualt nearst neighbor distances")
hist(nndist(crimePPP_Theft),breaks = 35, xlab = "distinace in meters", main = "Theft nearst neighbor distances")
```

```{r}

Assualt_Theft_Dist <- pppdist(crimePPP_Assault,crimePPP_Theft,type = "spa")
Assualt_Battery_Dist <- pppdist(crimePPP_Assault,crimePPP_Battery,type = "spa")
Assualt_Drug_Dist <- pppdist(crimePPP_Assault,crimePPP_Drug,type = "spa")
Assualt_Damage_Dist <- pppdist(crimePPP_Assault,crimePPP_Damage,type = "spa")

Assualt_Theft_Dist$distance

crime_distance_df <- data.frame(Theft = as.numeric(),Battery = as.numeric(),Drug = as.numeric(),Damage = as.numeric())
crime_distance_df$Theft = Assualt_Theft_Dist$distance
crime_distance_df
```

```{r}
#marks(X)
 
assualt_density <- density.ppp(crimePPP_Assault,sigma = bw.scott(crimePPP_Assault))
theft_density <- density.ppp(crimePPP_Theft,sigma = bw.scott(crimePPP_Theft))

# mean(nndist(crimePPP_Assault,k=1))*1000
# summary(crimePPP_Assault)

g12 = Gcross(X, "Assualt","Theft",assualt_density,theft_density,r=NULL,breaks=NULL, correction = "best")
plot( g12 )

X
```

### Plotting G-Function to identify whether there is clustering in each crime pattern
 
```{r}

```

### Spatial Modeling of Crime Data


## Temporal Analysis

### Time Series Forecasting with Recurrent Neural Networks

[EXPLAIN WHY WE ARE UTILIZING RNN]

#### Long SHort-Term Memory Units (LSTMs)

## DBSCAN Analysis

[INSERT EXPLAINATION WHY WE ARE USING DBSCAN - DUE TO US FINDING THAT THERE ARE CLUSTERING WITHIN OUR CRIME PATTERNS WE NOW WANT TO INVESTIGATE THESE CLUSTERS AND VISUALIZE IF THEY ARE THE SAME CLUSTERS FOUND IN POINT PATTERN ANALYSIS]

[WHAT IS DBSCAN - What is it used for in spatial clustering ]

### Attempting 
```{r include=FALSE}
# lon <- crime_spatial_df$Longitude
# lat <- crime_spatial_df$Latitude
# xrange <- range(lon,na.rm = T)
# yrange <- range(lat,na.rm = T)
# crime_ppp <- ppp(lon,lat,xrange,yrange,marks = as.factor(crime_spatial_df$crime))
```

```{r}
# plot(crime_ppp, main = "Our Crime PPP Object")
```

```{r}
# qc <- quadratcount(crime_ppp)
# plot(qc)
```

